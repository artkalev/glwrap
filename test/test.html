<head>
    <meta charset="UTF-8"></meta> 
    <style>
        body{
            background-color:black;
            margin:0;
            padding:0;
        }
    </style>
</head>
<body>
    <script src="../build/glwrap.js"></script>
    <script>
        // glwrap in action...

        // initializing a webgl context
        let canvas = document.createElement("canvas");
        let gl = canvas.getContext("webgl", {antialias:0});
        document.body.appendChild(canvas);

        // initializing view and projection matrices
        let view = new glwrap.Mat4();
        view.setTranslation( 0,0,5 );
        view.invert();
        let proj = new glwrap.Mat4();
        proj.perspective( Math.PI/2, canvas.width / canvas.height, 0.1, 100.0 );

        // initializing objects to draw with.
        let texture = new glwrap.Texture2D('./textures/cobblestone.png');
        let program = new glwrap.ShaderProgram(
            `
                precision mediump float;
                attribute vec3 position;
                attribute vec2 uv;
                uniform mat4 modelMatrix;
                uniform mat4 viewMatrix;
                uniform mat4 projMatrix;
                varying vec3 v_position;
                varying vec2 v_uv;
                void main(){
                    v_position = position;
                    v_uv = uv;
                    gl_Position = projMatrix * viewMatrix * modelMatrix * vec4( position, 1.0 );
                }
            `,
            `
                precision mediump float;
                uniform sampler2D colorTex;
                varying vec3 v_position;
                varying vec2 v_uv;
                void main(){
                    vec4 color = texture2D(colorTex, v_uv);
                    gl_FragColor = vec4( color.rgb, 1.0 );
                }
            `,
            {
                "colorTex":{ type:'t2d', value:texture }
            }
        );
        let mesh = new glwrap.Mesh([ 
            new glwrap.MeshAttribute(
                'position', 
                new Float32Array([ 
                    -1,-1,-1,  -1,-1, 1,  -1, 1, 1, //x-
                    -1,-1,-1,  -1, 1, 1,  -1, 1,-1, //x-
                     1,-1, 1,   1,-1,-1,   1, 1, 1, //x+
                     1, 1, 1,   1,-1,-1,   1, 1,-1, //x+
                    -1,-1,-1,   1, 1,-1,   1,-1,-1, //z-
                    -1,-1,-1,  -1, 1,-1,   1, 1,-1, //z-
                     1, 1, 1,  -1,-1, 1,   1,-1, 1, //z+
                    -1, 1, 1,  -1,-1, 1,   1, 1, 1, //z+
                     1,-1, 1,  -1,-1, 1,  -1,-1,-1, //y-
                     1,-1, 1,  -1,-1,-1,   1,-1,-1, //y-
                    -1, 1, 1,   1, 1, 1,  -1, 1,-1, //y+
                    -1, 1,-1,   1, 1, 1,   1, 1,-1  //y+
                ]),
                3,
                'FLOAT',
                false,
                'STATIC_DRAW'
            ),
            new glwrap.MeshAttribute(
                'uv',
                new Uint8Array([
                      0,  0,255,  0,255,255,
                      0,  0,255,255,  0,255,
                    255,  0,  0,  0,255,255,
                    255,255,0,0,  0,255,
                      0,  0,255,255,255,  0,
                      0,  0,  0,255,255,255,
                    255,255,  0,  0,255,  0,
                      0,255,  0,  0,255,255,
                    255,255,  0,255,  0,  0,
                    255,255,  0,  0,255,  0,
                      0,255,255,255,  0,  0,
                      0,  0,255,255,255,  0
                ]),
                2,
                'UNSIGNED_BYTE',
                true,
                'STATIC_DRAW'
            )
        ]);

        let obj = new glwrap.Transform(mesh, program);
        obj.onupdate = function(){
            this.localRot.rotateY(0.01);
            this.matrixNeedsUpdate = true;
        }
        let obj1 = new glwrap.Transform(mesh, program);
        obj1.setParent(obj);
        obj1.localPos.x = 2;
        obj1.localScale.set(0.5,0.5,0.5);
        obj1.onupdate = function(){
            this.localRot.rotateX(0.01);
            this.matrixNeedsUpdate = true;
        }
        let obj2 = new glwrap.Transform(mesh, program);
        obj2.setParent(obj);
        obj2.localPos.x = -2;
        obj2.localScale.set(0.5,0.5,0.5);
        obj2.onupdate = function(){
            this.localRot.rotateX(-0.01);
            this.matrixNeedsUpdate = true;
        }

        gl.clearColor(0.0, 0.5, 0.5, 1.0);

        function resize(){
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            proj.perspective(Math.PI/2, canvas.width/canvas.height, 0.1,100.0);
        }

        window.addEventListener('resize', resize);

        function mainloop(){
            requestAnimationFrame(mainloop);
            
            obj.update();
            obj1.update();
            obj2.update();
            
            gl.viewport(0,0,canvas.width,canvas.height);
            gl.clear(gl.COLOR_BUFFER_BIT | gl.DEPTH_BUFFER_BIT);
            
            obj.draw(gl, view, proj);
            obj1.draw(gl, view, proj);
            obj2.draw(gl, view, proj);
        }

        resize();
        mainloop();

    </script>
</body>