<head>
    <meta charset="UTF-8"></meta> 
    <style>
        body{
            background-color:black;
            margin:0;
            padding:0;
        }
    </style>
</head>
<body>
    <script src="../build/glwrap.js"></script>
    <script>
        // glwrap in action...

        // initializing a webgl context
        let canvas = document.createElement("canvas");
        let gl = canvas.getContext("webgl", {antialias:0});
        document.body.appendChild(canvas);

        // initializing view and projection with Camera
        let camera = new glwrap.Camera();
        camera.localPos.set(0,0,5);

        // initializing objects to draw with.
        let texture = new glwrap.Texture2D('./textures/cobblestone.png');
        let program = new glwrap.ShaderProgram(
            `
                precision mediump float;
                attribute vec3 position;
                attribute vec2 uv;
                uniform mat4 modelMatrix;
                uniform mat4 viewProjectionMatrix;
                varying vec3 v_position;
                varying vec2 v_uv;
                void main(){
                    v_position = position;
                    v_uv = uv;
                    gl_Position = viewProjectionMatrix * modelMatrix * vec4( position, 1.0 );
                }
            `,
            `
                precision mediump float;
                uniform sampler2D colorTex;
                varying vec3 v_position;
                varying vec2 v_uv;
                void main(){
                    vec4 color = texture2D(colorTex, v_uv);
                    gl_FragColor = vec4( color.rgb, 1.0 );
                }
            `,
            {
                "colorTex":{ type:'t2d', value:texture }
            }
        );
        let mesh = new glwrap.Mesh([ 
            new glwrap.MeshAttribute(
                'position', 
                new Float32Array([ 
                    -1,-1,-1,  -1,-1, 1,  -1, 1, 1, //x-
                    -1,-1,-1,  -1, 1, 1,  -1, 1,-1, //x-
                     1,-1, 1,   1,-1,-1,   1, 1, 1, //x+
                     1, 1, 1,   1,-1,-1,   1, 1,-1, //x+
                    -1,-1,-1,   1, 1,-1,   1,-1,-1, //z-
                    -1,-1,-1,  -1, 1,-1,   1, 1,-1, //z-
                     1, 1, 1,  -1,-1, 1,   1,-1, 1, //z+
                    -1, 1, 1,  -1,-1, 1,   1, 1, 1, //z+
                     1,-1, 1,  -1,-1, 1,  -1,-1,-1, //y-
                     1,-1, 1,  -1,-1,-1,   1,-1,-1, //y-
                    -1, 1, 1,   1, 1, 1,  -1, 1,-1, //y+
                    -1, 1,-1,   1, 1, 1,   1, 1,-1  //y+
                ]),
                3,
                'FLOAT',
                false,
                'STATIC_DRAW'
            ),
            new glwrap.MeshAttribute(
                'uv',
                new Uint8Array([
                      0,  0,255,  0,255,255,
                      0,  0,255,255,  0,255,
                    255,  0,  0,  0,255,255,
                    255,255,0,0,  0,255,
                      0,  0,255,255,255,  0,
                      0,  0,  0,255,255,255,
                    255,255,  0,  0,255,  0,
                      0,255,  0,  0,255,255,
                    255,255,  0,255,  0,  0,
                    255,255,  0,  0,255,  0,
                      0,255,255,255,  0,  0,
                      0,  0,255,255,255,  0
                ]),
                2,
                'UNSIGNED_BYTE',
                true,
                'STATIC_DRAW'
            )
        ]);

        let obj = new glwrap.Transform(mesh, program);
        obj.onupdate = function(){
            this.localPos.y = Math.sin(Date.now()/1000);
            this.matrixNeedsUpdate = true;
        }
        let obj1 = new glwrap.Transform(mesh, program);
        obj1.setParent(obj);
        obj1.localPos.x = 2;
        obj1.localScale.set(0.5,0.5,0.5);
        obj1.onupdate = function(){
            this.localRot.rotateX(0.01);
            this.matrixNeedsUpdate = true;
        }
        

        gl.clearColor(0.0, 0.5, 0.5, 1.0);

        function resize(){
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        }

        window.addEventListener('resize', resize);
        window.addEventListener('mousemove', onMouseMove);


        let cursorVec = new glwrap.Vec3();
        let mouseX = 0;
        let mouseY = 0;

        function onMouseMove(e){
            mouseX = e.clientX;
            mouseY = e.clientY;
        }

        let cursorCube = new glwrap.Transform(mesh, program);
        cursorCube.localScale.set(0.1,0.1,0.1);
        cursorCube.onupdate = function(){
            cursorVec.x = mouseX;
            cursorVec.y = mouseY;
            cursorVec.z = -1;
            camera.screenToWorld( cursorVec );
            this.localPos.copy(cursorVec);
            this.localRot.rotateX(0.01);
            this.localRot.rotateZ(0.01);
            this.matrixNeedsUpdate = true;
        };

        function mainloop(){
            requestAnimationFrame(mainloop);
            
            

            obj.update();
            obj1.update();

            

            cursorCube.update();
            camera.update();
            
            camera.setActive(gl);
            
            obj.draw(gl, camera.viewProjectionMatrix);
            obj1.draw(gl, camera.viewProjectionMatrix);
            cursorCube.draw(gl, camera.viewProjectionMatrix);
        }

        resize();
        mainloop();

    </script>
</body>